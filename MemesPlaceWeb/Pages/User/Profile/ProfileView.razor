@page "/users/profile/{username}"
@page "/users/profile"
@inject IMemesService _memeService
@inject AuthenticationStateProvider authenticationState
<MudContainer>
    <MudStack Class="col-4">
        <MudAvatar Image="@profile.ProfilePic"></MudAvatar>
        <MudText>@profile.UserName</MudText>
    </MudStack>
    <MudStack Class="col-8">
        <MudText>The best memes of @profile.UserName</MudText>
        @foreach (var item in profile.LastMemes)
        {
            <MemeComponent meme="item"></MemeComponent>
            
        }
    </MudStack>
</MudContainer>

@code {
    [Parameter]
    public string username { get; set; }
    private ProfileDTO profile= new ProfileDTO() {  LastMemes=new HashSet<MemeDTO>()};
    [Inject] private IDialogService DialogService { get; set; }
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if(firstRender)
        {
            var auth = await authenticationState.GetAuthenticationStateAsync();
            if (username == null && auth.User.Identity.IsAuthenticated)
            {
                username = auth.User.Identity.Name;
            }
            await GetProfile();
            StateHasChanged();
        }

    }
    
       
        
    

    private async Task GetProfile()
    {
        try
        {
             var result = await _memeService.GetProfile(username);
        if (result.IsSuccess)
        {
            profile = result.Data;
        }
        else
        {
            

        }
        }
        catch (Exception ex)
        {
            bool? result = await DialogService.ShowMessageBox(
               "Warning",
               $"Error retriving memes, {ex.Message}"
               );
            
        }
       
    }

   
}
